name: Releases

on:
  push:
    tags:
      - "v*"
    branches:
      - main

jobs:
  release:
    name: Build & Release
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Release Variables
        id: vars
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "IS_DRAFT=false" >> $GITHUB_ENV
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
            echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV
            echo "RELEASE_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV
            echo "PRERELEASE=false" >> $GITHUB_ENV
          else
            echo "IS_DRAFT=true" >> $GITHUB_ENV
            echo "VERSION=0.0.0-draft" >> $GITHUB_ENV
            echo "TAG_NAME=rolling-draft" >> $GITHUB_ENV
            echo "RELEASE_NAME=Rolling Draft" >> $GITHUB_ENV
            echo "PRERELEASE=true" >> $GITHUB_ENV
          fi

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_16.2.app/Contents/Developer

      - name: Install Tools
        run: |
          brew install create-dmg

      - name: Generate Icon
        run: |
          chmod +x generate_icon.sh
          ./generate_icon.sh

      - name: Build Universal Binary
        run: |
          # Build for x86_64
          swift build -c release --arch x86_64
          # Build for arm64
          swift build -c release --arch arm64
          
          # Create directory for universal binary
          mkdir -p .build/universal
          
          # Merge binaries using lipo
          lipo -create -output .build/universal/XPlaneLauncher \
            .build/x86_64-apple-macosx/release/XPlaneLauncher \
            .build/arm64-apple-macosx/release/XPlaneLauncher
            
          # Verify architecture
          lipo -info .build/universal/XPlaneLauncher

      - name: Create App Bundle
        run: |
          chmod +x package.sh
          # Run package script to create structure
          ./package.sh
          
          # Overwrite with universal binary
          cp .build/universal/XPlaneLauncher XLauncher.app/Contents/MacOS/XLauncher
          
          # Update Version in Info.plist
          plutil -replace CFBundleShortVersionString -string "$VERSION" XLauncher.app/Contents/Info.plist
          plutil -replace CFBundleVersion -string "$VERSION" XLauncher.app/Contents/Info.plist
          
          # Resign the app after modification
          codesign -f -s - XLauncher.app

      - name: Create DMG
        run: |
          create-dmg \
            --volname "XLauncher Installer" \
            --volicon "XLauncher.app/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "XLauncher.app" 200 190 \
            --hide-extension "XLauncher.app" \
            --app-drop-link 600 185 \
            "XLauncher.dmg" \
            "XLauncher.app"

      - name: Generate Changelog
        run: |
          if [ "$IS_DRAFT" = "true" ]; then
            # Get previous tag
            PREVIOUS_TAG=$(git tag --sort=-version:refname | head -n 1 || true)
            CURRENT_TAG="HEAD"

            echo "# Draft Release" > RELEASE_CHANGELOG.md
            echo "" >> RELEASE_CHANGELOG.md
            echo "This is a rolling draft release generated from the latest commit on main." >> RELEASE_CHANGELOG.md
            echo "" >> RELEASE_CHANGELOG.md
            echo "## Changes since $PREVIOUS_TAG" >> RELEASE_CHANGELOG.md
            echo "" >> RELEASE_CHANGELOG.md
          else
            # Get previous tag
            PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^${TAG_NAME}$" | head -n 1 || true)
            CURRENT_TAG=${TAG_NAME}
            
            echo "# Changes in $CURRENT_TAG" > RELEASE_CHANGELOG.md
            echo "" >> RELEASE_CHANGELOG.md
          fi

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
            
          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG >> RELEASE_CHANGELOG.md

      - name: Delete Previous Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete rolling-draft --cleanup-tag -y || true

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: XLauncher.dmg
          body_path: RELEASE_CHANGELOG.md
          prerelease: ${{ env.PRERELEASE }}
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
